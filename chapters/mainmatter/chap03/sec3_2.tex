
\section{方法}
\label{sec3_2}

本节介绍主动脉内腔分割过程中各个环节的数学原理和实现细节。

整个处理流程的设计如图\ref{fig:DataFlow3}所示。
原始医学图像进行数据格式的转换之后，作为同时开始的两项不同计算任务的输入：一项用于计算并生成边缘势场，另一项用于生成距离图。
这两项计算完成后，其结果即作为主动脉内腔分割的核心环节的输入数据，为该环节提供演进计算的参考。
最后，分割所得结果（即：主动脉内腔）经过亮度的反转变换，再利用行进立方体方法提取其等值面（即：边缘），进而通过表面渲染技术获得主动脉内腔模型的立体可视效果。
\begin{figure}[t]
\centering
\includegraphics[width=3.2in]{figures/chap03/DataFlow.eps}
\caption[主动脉分割的流程]{基于测地学活动轮廓的主动脉分割方法的工作流程。}
\label{fig:DataFlow3}
\end{figure}

\subsection{预处理}

对原始图像的若干预处理工作需要在主要的处理工作开始之前完成。
考虑分割工作所选取的方法的需求，预处理应当包括特征图像的生成，以及输入水平集的生成。
特征图像为测地学活动轮廓方法提供轮廓演进的终止位置，这正如一幅“地图”，其中标的何处是“平原”（指像素亮度均匀一致的区域），何处是“峡谷”（指像素亮度明显有别于周围的狭长区域）；
而输入水平集则为测地学活动轮廓方法提供轮廓演进的起始轮廓，轮廓的最初位置由输入水平集所确定。

\subsubsection{特征图像的生成}
\label{sec:EdgePotential}

对图像的平滑处理是一项必须的环节，该环节的目的在于除去在医学模态获取原始图像序列的过程当中所引入的噪声像素，这一现象是不可避免的。
在平滑处理过程当中，目标（此处指主动脉）的原始边缘信息应当得到尽可能完整地保护。
基于这些考虑，我们选择使用一种具有可变通透性的水平集曲率方法\cite{Whitaker2001}来完成这一环节的处理工作。
该方法长于在图像平滑的过程中增强和保护边缘信息，且对边缘对比度变化具有很好的鲁棒性。
该方法可以通过所谓的“改进型曲率扩散方程”（Modified Curvature Diffusion Equation，MCDE）来表达：
\begin{equation}
\label{eqn:MCDE}
I_t = |\nabla I| \nabla \cdot c(|\nabla I|) \frac{\nabla I}{|\nabla I|},
\end{equation}
其中，$I = I(x, y, 0)$表示输入图像，
$I_t(\cdot) = I(x, y, t)$表示图像像素关于时间$t$的偏导数，
$c$是通透性函数$c(|\nabla I|) = k^2/(k^2 + |\nabla I|^2)$，
边界的对比度将会对图像的平滑显著的影响，它由参数$k$所决定。

由于即将生成的特征图像是随后进行的活动轮廓演进的必须信息，因此对图像像素的梯度计算即在此完成平滑处理后的图像上进行。
这一环节的目的是探测目标的边缘。
图像像素的梯度计算基本原理可表述如下：
\begin{equation}
\label{eqn:Gaussian}
I_{grad} = \exp(-|(\nabla \ast G) \cdot I_t|),
\end{equation}
其中，$I_{grad}$表示图像中某像素点的梯度的幅值，
$\nabla \ast G$代表对高斯算子进行一阶求导运算。

随后，上述计算所得的梯度幅值图像将通过一个非线性关系映射生成所需的特征图像，本文中，我们采用了S型函数：
\begin{equation}
\label{eqn:Sigmoid}
I_{\sigma} = (I_{max} - I_{min}) \cdot \frac{1}{1 + \exp\left(-\frac{I_{grad} - n}{m}\right)} + I_{min},
\end{equation}
其中，$I_{\sigma}$表示输出图像的像素亮度，
$I_{max}$与$I_{min}$分别代表输出像素亮度的最大值和最小值，
$m$是一个常量，它控制输入图像中参与映射的像素亮度的区间，
$n$则是一个确定该区间中心点的位置的常量。
此映射的结果取决于上述参数的选择。

\subsubsection{初始水平集的半自动生成}

初始水平集的生成工作与\ref{sec:EdgePotential}所述之工作同时进行，该环节的目的在于生成活动轮廓演进所需的输入水平集。
首先，我们利用阈值环节将图像中与水平集演进无关的内容细节（如：内脏，骨骼，等）滤去。
然后，我们引入快速行进法\cite{Sethian1999}。
这时，由于无关细节已经从图像中除去，因此该方法能够得以高效地进行处理。
需要指出的是，在快速行进法开始时，我们需要手工输入该运算在图像中的起始位置（点的坐标），这也是“半自动生成”的由来。

对关于时间参数$t$演化的曲线：
\begin{equation}
\label{eqn:Curves}
\mathcal{C}(t) = \{(x,y) | T(x,y) = t\},
\end{equation}
其中，$(x,y)$表示图像中某点的二维坐标，
$T(x,y)$表示该曲线到达该点的时刻。
该方法实际上是求解下面的Eikonal方程（稳态的Hamilton-Jacobi方程）
\begin{equation}
1 = | \nabla T | F,
\end{equation}
其中，$F$表示图像内某点$(x,y)$处，该曲线沿着其发现方向演进的速度。
当$F < 0$时，$\mathcal{C}$向“内”演进；反之，则向“外”演进。
计算的结果是一幅到达时间图，图中的各点所对应的函数值是曲线$\mathcal{C}$演进过程中到达该点的时刻。
因此，此结果事实上记录了整个演进过程。

\subsection{测地学活动轮廓方法}

获得上述两个结果后，我们利用测地学活动轮廓方法进行血管内壁的分割计算。
如上所述，特征图像为这一轮廓演进过程提供一个类似地形图的指引。

经典的“蛇”或活动轮廓模型最早由Kass等人\cite{Kass1988}提出，该方法主要用于图像中的物体边缘的探测。
其主导思想是通过演进一个轮廓（或“围线”）$\mathcal{C}$，以检测得出目标物体的边缘信息。
这一演进过程实际上是通过使一个能量泛函最小化来实现的，取得这个（局部）最小值的位置恰好是目标物体的边缘。

然而，该方法中的轮廓是无法控制其自身的拓扑的。
这时，若无额外的处理，该方法则无法完成同时探测多个目标的任务\cite{Caselles1997}。
Caselles等人\cite{Caselles1997}改进了经典的“蛇”模型――提出了测地活动轮廓方法，该方法允许围线同时探测图像中的多个目标的内部边缘和外部边缘。
这一方法引入了测地学计算和水平集演进的概念，其数学模型事实上是经典模型的一个特例：\begin{equation}
\label{eqn:ParticularSnakes}
E(\mathcal{C}) = \alpha \int_0^1 | \mathcal{C}'(q) |^2 dq - \lambda \int_0^1 | \nabla I_{s} ( \mathcal{C}(q) ) |dq,
\end{equation}
其中，$\mathcal{C}(\cdot)$表示参数化的平面内曲线$\mathcal{C}(q):[0,1]\rightarrow \mathrm{R}^2$，
$I_{s}:[0,a]\times [0,b]\rightarrow \mathrm{R}^{+}$代表含有待探测目标物体的图像。

为最小化式(\ref{eqn:ParticularSnakes})所定义的泛函，通过取得最大值的点$|\nabla I_{s}|$的曲线的位置必须确定。
在这一过程中，还必须保持该曲线的某种程度的平滑性。
在式(\ref{eqn:ParticularSnakes})中，$|\nabla I_{s}|$可以由$-g(|\nabla I_{s}|)$所替换，其中$g(\cdot): [0, \infty) \rightarrow \mathrm{R}^{+}$是一个单调递减函数。
由此可以得到如下的能量泛函：
\begin{equation}
\label{eqn:GeneralEnergy}
E(\mathcal{C}) = \alpha \int_0^1 | \mathcal{C}'(q) |^2 dq + \lambda \int_0^1 g( | \nabla I_{s} ( \mathcal{C}(q) ) | )^2 dq.
\end{equation}
演进的目的是为了获得
\begin{equation}
\label{eqn:MinModel}
\min \int_0^1 g(|\nabla I_{s} ( \mathcal{C} (q) )|) |\mathcal{C}' (q)| dq.
\end{equation}
在式(\ref{eqn:GeneralEnergy})中，$g(\cdot)$等同于曲线演进的速度。
而且它也依赖图像细节的几何性质。
为了获得理想的目标物体的边缘探测结果，参数$g(\cdot)$的选择是独立于测地学计算的。
因此，式(\ref{eqn:MinModel})所表示的最小值可以重新表示为：
\begin{equation}
\label{eqn:MinModel2}
\min \int_0^1 g(I_{\sigma}) |\mathcal{C}' (q)| dq.
\end{equation}
为了获得式(\ref{eqn:MinModel2})所表示的最小值，需要计算该模型的Euler-Lagrange方程：
\begin{equation}
\label{eqn:EvolutionModel}
\frac{\partial \mathcal{C}(t)}{\partial t} = g(I_{\sigma}) \kappa \mathcal{N} - (\nabla g(I_{\sigma}) \cdot \mathcal{N}) \mathcal{N},
\end{equation}
其中$\kappa$表示曲线$\mathcal{C}(t)$的曲率，$\mathcal{N}$是指向“内部”的单位法向量。
该方程刻画了曲线$\mathcal{C}$向欲探测的目标物体不断演进的过程。
初始曲线为$\mathcal{C}(0) = \mathcal{C}_0$，它的演进目标就是式(\ref{eqn:MinModel2})所表示的（局部）最小值。

根据式(\ref{eqn:EvolutionModel})，该演进过程将会在$\frac{\partial \mathcal{C}(t)}{\partial t} = 0$时停止，这意味着目标物体的边缘被成功探知。
假设曲线$\mathcal{C}$是一个函数的水平集$u(\cdot):[0,a] \times [0,b] \rightarrow \mathrm{R}$。
考虑式(\ref{eqn:MinModel2})和式(\ref{eqn:EvolutionModel})，之前的测地学计算即可转换为寻找如下方程的稳态解：
\begin{equation}
\label{eqn:LevelSetModel}
\begin{split}
\frac{\partial u}{\partial t} & = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) \\
                              %& = g(I_{\sigma}) |\nabla u| \textrm{div} \left(\frac{\nabla u}{|\nabla u|}\right) + \nabla g(I_{\sigma}) \cdot \nabla u \\
                              & = g(I_{\sigma}) |\nabla u| \kappa + \nabla g(I_{\sigma}) \cdot \nabla u,
\end{split}
\end{equation}
其中，$\kappa = \textrm{div}\left(\frac{\nabla u}{|\nabla u|}\right)$。
该方程的等号右侧即为式(\ref{eqn:MinModel2})中的Euler-Lagrange。

为了增加作用于围线的“吸引力”（该吸引力将围线向着目标物体的边缘吸引），并且允许探测非凸性目标物体，向式(\ref{eqn:LevelSetModel})中引入$cg(I_{\sigma})|\nabla u|$，可得：
(\ref{eqn:LevelSetModel}):
\begin{equation}
\label{eqn:Geodesic1}
\frac{\partial u}{\partial t} = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) + c g(I_{\sigma}) |\nabla u|,
\end{equation}
其中，$c$为一常量，满足$c \in \mathrm{R}^+$。
考虑式(\ref{eqn:LevelSetModel})，上述方程又可以表示为：
\begin{equation}
\label{eqn:Geodesic2}
\frac{\partial u}{\partial t} = g( I_{\sigma} )( c + \kappa ) |\nabla u| + \nabla u \cdot \nabla g(I_{\sigma}).
\end{equation}
此方程可以转换为下面的方程：
\begin{equation}
\label{eqn:Geodesic3}
\frac{\partial \mathcal{C}}{\partial t} = g(I_{\sigma}) ( c + \kappa ) \mathcal{N} - ( \nabla g(I_{\sigma}) \cdot \mathcal{N} ) \mathcal{N}.
\end{equation}
这里，探测目标物体边缘的问题的解就等价于式(\ref{eqn:Geodesic1})的稳态（$u_t = 0$）的零水平集。

\subsection{等值面的提取}

要实现表面模型的可视化，就必须提取目标物体的表面信息（即已经获得的目标物体的边缘信息）。
这里，我们采用了行进立方体方法\cite{Lorensen1987MC}。
作为表面提取的初始步骤，该方法基于输入信息创建了立方体群。
其中，对于每个立方体的八个顶点，四个位于某一帧图像，另外四个则位于与之相邻的另外一帧图像。
然后，该方法通过比较八个顶点的亮度与指定的目标物体的等值面的值，来计算每个立方体的索引值。
通过引用这些索引值所对应的三角形相交关系，目标物体与立方体群的相交关系就能够粗略地确定。
之后，精确的边缘相交关系则通过计算各立方体中的各个顶点处的亮度的线性插值来获得。
随后，该方法利用中心差分方法来计算表面模型位于这些立方体的各个顶点位置的法向量。
所得到的三角形面片则传输至计算机的图形处理系统，并通过标准的渲染技术显示。
