
\section{方法}
\label{sec3_2}

本节介绍主动脉内腔分割过程中各个环节的数学原理和实现细节。

整个处理流程的设计如图\ref{fig:DataFlow3}所示。
原始医学图像进行数据格式的转换之后，作为同时开始的两项不同计算任务的输入：一项用于计算并生成边缘势场，另一项用于生成距离图。
这两项计算完成后，其结果即作为主动脉内腔分割的核心环节的输入数据，为该环节提供演进计算的参考。
最后，分割所得结果（即：主动脉内腔）经过亮度的反转变换，再利用行进立方体方法提取其等值面（即：边缘），进而通过表面渲染技术获得主动脉内腔模型的立体可视效果。
\begin{figure}[t]
\centering
\includegraphics[width=3.2in]{figures/chap03/DataFlow.eps}
\caption[主动脉分割的流程]{基于测地学活动轮廓的主动脉分割方法的工作流程。}
\label{fig:DataFlow3}
\end{figure}

\subsection{预处理}

对原始图像的若干预处理工作需要在主要的处理工作开始之前完成。
考虑分割工作所选取的方法的需求，预处理应当包括特征图像的生成，以及输入水平集的生成。
特征图像为测地学活动轮廓方法提供轮廓演进的终止位置，这正如一幅“地图”，其中标的何处是“平原”（指像素亮度均匀一致的区域），何处是“峡谷”（指像素亮度明显有别于周围的狭长区域）；
而输入水平集则为测地学活动轮廓方法提供轮廓演进的起始轮廓，轮廓的最初位置由输入水平集所确定。

\subsubsection{特征图像的生成}
\label{sec:EdgePotential}

对图像的平滑处理是一项必须的环节，该环节的目的在于除去在医学模态获取原始图像序列的过程当中所引入的噪声像素，这一现象是不可避免的。
在平滑处理过程当中，目标（此处指主动脉）的原始边缘信息应当得到尽可能完整地保护。
基于这些考虑，我们选择使用一种具有可变通透性的水平集曲率方法\cite{Whitaker2001}来完成这一环节的处理工作。
该方法长于在图像平滑的过程中增强和保护边缘信息，且对边缘对比度变化具有很好的鲁棒性。
该方法可以通过所谓的“改进型曲率扩散方程”（Modified Curvature Diffusion Equation，MCDE）来表达：
\begin{equation}
\label{eqn:MCDE}
I_t = |\nabla I| \nabla \cdot c(|\nabla I|) \frac{\nabla I}{|\nabla I|},
\end{equation}
其中，$I = I(x, y, 0)$表示输入图像，
$I_t(\cdot) = I(x, y, t)$表示图像像素关于时间$t$的偏导数，
$c$是通透性函数$c(|\nabla I|) = k^2/(k^2 + |\nabla I|^2)$，
边界的对比度将会对图像的平滑显著的影响，它由参数$k$所决定。

由于即将生成的特征图像是随后进行的活动轮廓演进的必须信息，因此对图像像素的梯度计算即在此完成平滑处理后的图像上进行。
这一环节的目的是探测目标的边缘。
图像像素的梯度计算基本原理可表述如下：
\begin{equation}
\label{eqn:Gaussian}
I_{grad} = \exp(-|(\nabla \ast G) \cdot I_t|),
\end{equation}
其中，$I_{grad}$表示图像中某像素点的梯度的幅值，
$\nabla \ast G$代表对高斯算子进行一阶求导运算。

随后，上述计算所得的梯度幅值图像将通过一个非线性关系映射生成所需的特征图像，本文中，我们采用了S型函数：
\begin{equation}
\label{eqn:Sigmoid}
I_{\sigma} = (I_{max} - I_{min}) \cdot \frac{1}{1 + \exp\left(-\frac{I_{grad} - n}{m}\right)} + I_{min},
\end{equation}
其中，$I_{\sigma}$表示输出图像的像素亮度，
$I_{max}$与$I_{min}$分别代表输出像素亮度的最大值和最小值，
$m$是一个常量，它控制输入图像中参与映射的像素亮度的区间，
$n$则是一个确定该区间中心点的位置的常量。
此映射的结果取决于上述参数的选择。

\subsubsection{初始水平集的半自动生成}

初始水平集的生成工作与\ref{sec:EdgePotential}所述之工作同时进行，该环节的目的在于生成活动轮廓演进所需的输入水平集。
首先，我们利用阈值环节将图像中与水平集演进无关的内容细节（如：内脏，骨骼，等）滤去。
然后，我们引入快速行进法\cite{Sethian1999}。
这时，由于无关细节已经从图像中除去，因此该方法能够得以高效地进行处理。
需要指出的是，在快速行进法开始时，我们需要手工输入该运算在图像中的起始位置（点的坐标），这也是“半自动生成”的由来。

对关于时间参数$t$演化的曲线：
\begin{equation}
\label{eqn:Curves}
\mathcal{C}(t) = \{(x,y) | T(x,y) = t\},
\end{equation}
其中，$(x,y)$表示图像中某点的二维坐标，
$T(x,y)$表示该曲线到达该点的时刻。
该方法实际上是求解下面的Eikonal方程（稳态的Hamilton-Jacobi方程）
\begin{equation}
1 = | \nabla T | F,
\end{equation}
其中，$F$表示图像内某点$(x,y)$处，该曲线沿着其发现方向演进的速度。
当$F < 0$时，$\mathcal{C}$向“内”演进；反之，则向“外”演进。
计算的结果是一幅到达时间图，图中的各点所对应的函数值是曲线$\mathcal{C}$演进过程中到达该点的时刻。
因此，此结果事实上记录了整个演进过程。

\subsection{测地学活动轮廓方法}

%The module that actually working towards the segmentation is illustrated in Fig. \ref{fig:DataFlow}.
At this point, the geodesic active contours module has its two inputs available: the feature images and the initial level sets.
The feature images provide the maps for the interface evolution initialized by the input level sets.
The classical ``snakes" or active contour models for boundary detection were proposed by Kass et al. \cite{Kass1988}.
The idea is to evolve a contour $\mathcal{C}$ such that the edge of the object can be detected.
This evolution is achieved by minimizing an energy functional whose (local) minimum can be found at the edge of the object.
% This energy functional of the contour $\mathcal{C}_0$ in the classical snakes approach is given by (the denotation is adopted from \cite{Caselles1997})
% \setlength{\arraycolsep}{0.0em}
% \begin{eqnarray}
% \label{eqn:Snakes}
% E(\mathcal{C})&{}={}&\alpha \int_0^1 |\mathcal{C}'(q)|^2 dq + \beta \int_0^1 |\mathcal{C}''(q)|^2 dq \nonumber \\
                  % &&{-}\:\lambda \int_0^1 |\nabla I ( \mathcal{C}(q) ) | dq,
% \end{eqnarray}
\setlength{\arraycolsep}{5pt}
% where $\mathcal{C}(q)$ denotes the parametrized planar curve $\mathcal{C}(q):[0,1]\rightarrow \mathrm{R}^2$, $I:[0,a]\times [0,b]\rightarrow \mathrm{R}^{+}$ represents an image on which the edge detection task is carried out, and $\alpha$, $\beta$, and $\lambda$ are all real positive constants.
% The first two components control the smoothness of the curves to be detected, and the last one propagates the curve outwards (or inwards) until it ``touches" boundaries of the objects in the given image.
% The classical problem is to find the curve $\mathcal{C}$ that minimizes the energy functional $E$, for the given constants $\alpha$, $\beta$, and $\lambda$.
However, the curve in this approach cannot deal with the change of its topology so that detecting more than one object in the image is impossible without additional procedures \cite{Caselles1997}.
Caselles \textit{et al.} \cite{Caselles1997} improved the classical ``snakes" by proposing the geodesic active contours method, which allows to detect both the internal and external boundaries of several objects simultaneously.
This method incorporates the concepts of geodesic computation and level set evolution.
The proposed model is a particular case of the classical model:
\begin{equation}
\label{eqn:ParticularSnakes}
E(\mathcal{C}) = \alpha \int_0^1 | \mathcal{C}'(q) |^2 dq - \lambda \int_0^1 | \nabla I_{s} ( \mathcal{C}(q) ) |dq,
\end{equation}
where $\mathcal{C}(\cdot)$ denotes the parametrized planar curve $\mathcal{C}(q):[0,1]\rightarrow \mathrm{R}^2$, $I_{s}:[0,a]\times [0,b]\rightarrow \mathrm{R}^{+}$ represents an image on which the edge detection task is carried out.

To minimize the functional defined by (\ref{eqn:ParticularSnakes}), the curve at the points of maxima $|\nabla I_{s}|$ must be located.
During this process, certain level of smoothness of the curve also needs to be kept.
In (\ref{eqn:ParticularSnakes}), $|\nabla I_{s}|$ can be substituted by $-g(|\nabla I_{s}|)$, where $g(\cdot): [0, \infty) \rightarrow \mathrm{R}^{+}$ is a monotonically decreasing function. %such that $\lim_{x \to \infty} g(x) = 0}$.
Hence, a general energy functional is obtained
\begin{equation}
\label{eqn:GeneralEnergy}
E(\mathcal{C}) = \alpha \int_0^1 | \mathcal{C}'(q) |^2 dq + \lambda \int_0^1 g( | \nabla I_{s} ( \mathcal{C}(q) ) | )^2 dq.
\end{equation}
The aim of the evolution is trying to obtain
\begin{equation}
\label{eqn:MinModel}
\min \int_0^1 g(|\nabla I_{s} ( \mathcal{C} (q) )|) |\mathcal{C}' (q)| dq.
\end{equation}
% Thus the problem has been shifted from the minimization of (\ref{eqn:ParticularSnakes}) to the geodesic computation.
In (\ref{eqn:GeneralEnergy}), $g(\cdot)$ is equivalent to the speed of the evolution of the curve.
And it is also dependent upon the geometry of the image content.
For the ideal edges of the objects to be detected, the choice of parameter $g(\cdot)$ is independent of their geodesic computation.
So the minimum given in (\ref{eqn:MinModel}) can be rewritten as:
\begin{equation}
\label{eqn:MinModel2}
\min \int_0^1 g(I_{\sigma}) |\mathcal{C}' (q)| dq.
\end{equation}
To obtain the minimum given in (\ref{eqn:MinModel2}), the following Euler-Lagrange associated with this model needs to be calculated
\begin{equation}
\label{eqn:EvolutionModel}
\frac{\partial \mathcal{C}(t)}{\partial t} = g(I_{\sigma}) \kappa \mathcal{N} - (\nabla g(I_{\sigma}) \cdot \mathcal{N}) \mathcal{N},
\end{equation}
where $\kappa$ is the curvature of $\mathcal{C}(t)$, $\mathcal{N}$ is the unit inward normal vector. %, and the right-hand side of the equation is the computation of Euler-Lagrange.
This equation presents the way $\mathcal{C}$ evolving towards the boundaries of the objects to be detected.
The initial curve is marked as $\mathcal{C}(0) = \mathcal{C}_0$, which evolves to a (local) minimum of (\ref{eqn:MinModel2}).

According to (\ref{eqn:EvolutionModel}), this evolution will stop when $\frac{\partial \mathcal{C}(t)}{\partial t} = 0$, meaning that the boundaries of the objects are detected.
Suppose that the curve $\mathcal{C}$ is a level-set of a function $u(\cdot):[0,a] \times [0,b] \rightarrow \mathrm{R}$.
Regarding (\ref{eqn:MinModel2}) and (\ref{eqn:EvolutionModel}), the former geodesic calculation is transformed to finding the steady state solution of the following equation:
\begin{equation}
\label{eqn:LevelSetModel}
\begin{split}
\frac{\partial u}{\partial t} & = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) \\
                              %& = g(I_{\sigma}) |\nabla u| \textrm{div} \left(\frac{\nabla u}{|\nabla u|}\right) + \nabla g(I_{\sigma}) \cdot \nabla u \\
                              & = g(I_{\sigma}) |\nabla u| \kappa + \nabla g(I_{\sigma}) \cdot \nabla u,
\end{split}
\end{equation}
where $\kappa = \textrm{div}\left(\frac{\nabla u}{|\nabla u|}\right)$.
The right-hand side of this equation is the Euler-Lagrange of (\ref{eqn:MinModel2}).
% Here in this equation, $u$ is the embedding function mentioned above that deforms according to $u_t = \beta |\nabla u|$, where $\beta$ is a function computed on the level sets.
% From the perspective of image segmentation, a positive real constant $c$ is introduced in order to detect the boundaries of a non-convex object using a convex initial curve
% \begin{equation}
% \label{eqn:ImprovedLevelSetModel}
% \begin{split}
% \frac{\partial u}{\partial t} & = g(I) |\nabla u| \textrm{div} \left(\frac{\nabla u}{|\nabla u|}\right) + c g(I) |\nabla u| \\
                              % & = g(I) ( \kappa + c ) |\nabla u|.
% \end{split}
% \end{equation}

In order to increase the ``attractive force" to the contour towards the edges and allow the detection of non-convex objects, the term $cg(I_{\sigma})|\nabla u|$ is added to (\ref{eqn:LevelSetModel}):
\begin{equation}
\label{eqn:Geodesic1}
\frac{\partial u}{\partial t} = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) + c g(I_{\sigma}) |\nabla u|,
\end{equation}
where $c$ is a constant and $c \in \mathrm{R}^+$.
Regarding (\ref{eqn:LevelSetModel}), the above equation can be rewritten as
\begin{equation}
\label{eqn:Geodesic2}
\frac{\partial u}{\partial t} = g( I_{\sigma} )( c + \kappa ) |\nabla u| + \nabla u \cdot \nabla g(I_{\sigma}).
\end{equation}
% which means that the level sets move according to
The above equation can be transformed to the following equation
\begin{equation}
\label{eqn:Geodesic3}
\frac{\partial \mathcal{C}}{\partial t} = g(I_{\sigma}) ( c + \kappa ) \mathcal{N} - ( \nabla g(I_{\sigma}) \cdot \mathcal{N} ) \mathcal{N}.
\end{equation}
The solution to this object detection problem is equivalent to the zero level-set of the steady state ($u_t = 0$) of (\ref{eqn:Geodesic1}).
%Comparing (\ref{eqn:EvolutionModel}) and (\ref{eqn:Geodesic3}), one can find an added term $c g(I_{\sigma}) \mathcal{N}$, which is corresponding to the
% For the ideal edges of the objects to be detected, the choice of parameter $g$ is independent of their geodesic computation.
% It is a very simple edge detector which is given by the following equation
% \begin{equation}
% \label{eqn:EdgeDetector}
% g = \frac{1}{1+\|\nabla \hat{I}\|^p},
% \end{equation}
% where $\hat{I}$ denotes a Gaussian-smoothed image of the original $I$ and $p$ is the exponential of $\hat{I}$.
% What we are interested in is the time when the curve interface corresponding to the edges of the target.
% After the evolution stopped, a binary thresholder is provoked to take a ``snapshot" of this interface.
% This resulting level set should be the edges of the objects to be detected.

\subsection{等值面的提取}

To visualize the surface model, the surface information should be firstly extracted by the marching cubes method \cite{Lorensen1987MC}.
As the initial step of surface extraction, arrays of cubes are created from the input with each cube consisting of eight pixels (four from one slice and the other four from the next slice).
Then the index for each cube is calculated by comparing the eight intensity values to the specified isovalue corresponding to the surfaces of the objects.
By referring to the triangulated cases with the indexes, the intersection patterns of the objects and the cubes can be roughly determined.
Then the precise edge intersections are computed using linear interpolation with the intensity values at each vertex of the cubes.
After that, the unit normals to the surface at each vertex of these cubes are computed via central differences.
The resulting triangles are then sent to the graphics systems and displayed by standard rendering techniques.
% The isovalue representing the edge of the segmented target is selected.
% Then the 3-D model of the target can be reconstructed.
% That is the 3-D surface model of the lumen of the aorta.