
\section{方法}
\label{sec7-2}

\subsection{工作流程一览}
\label{sec:overview}

本章所述的基于CT的心脏分割工作的完整流程如图\ref{fig:DataFlow7}所示。
首先，对原始影像数据进行平滑处理。
随后，将平滑处理后的影像数据通过阈值滤波转换为边缘保持较完整的二值图像。
第三，同时计算二值图像的特征图像和输入水平集。
第四，利用活动轮廓方法获得心脏区域的边界。
最后，在上一步工作的基础上，对心脏表面模型进行可视化。
\begin{figure}[t]
\centering
\includegraphics[height=2.0in]{figures/chap07/DataFlow.eps}
\caption{Flowchart of the segmentation work flow.}
\label{fig:DataFlow7}
\end{figure}

\subsection{预处理}
\label{sec:preprocessing}

\subsubsection{具有边缘保护作用的图像平滑处理}

在图像获取环节中引入的颗粒性噪声会给随后进行的分割工作带来相当大的不利影响。
因此，在其处理环节开始前，对影像进行平滑处理是必要的。
平滑处理的原则是尽可能多地除去图像中的噪声，同时尽可能完整地保护图像内容的细节，尤其是物体的边缘细节。
为此，我们采用了一种基于MCDE的平滑算法\cite{Whitaker2001}：
\begin{equation}
\label{eqn:MCDE}
\frac{\partial I}{\partial t} = |\nabla I| \nabla \cdot c(|\nabla I|) \frac{\nabla I}{|\nabla I|},
\end{equation}
其中，$I(\cdot)$代表输入图像，$c$代表通透性函数$c(|\nabla I|) = k^2/(k^2 + |\nabla I|^2)$，其中$k$为自由选定的参数，它决定着边缘的对比度。

\subsubsection{二值阈值滤波}

为了获得“形状完好的”图像，我们引入了阈值滤波运算来处理平滑后的影像。
在阈值滤波的过程中，与本章工作目标无关的图像内容的像素的亮度将会被统一地赋值为零，而相关的图像内容的像素的亮度将会被统一地赋值为$255$（如图\ref{fig:BinaryThresholdFunc}所示）：
\begin{equation}
\label{eqn:BinaryThreshold}
I_{\text{output}} =
\begin{cases}
255, & \text{lower} \le I_{\text{input}} \le \text{upper}, \\%
0,   & \text{otherwise}.
\end{cases}
\end{equation}

\subsubsection{梯度幅值的计算}

The gradient magnitude of the images need to be calculated to generate the so-called edge potential map, which can provide guidance to the evolution of the contours.
The calculation can be performed by
\begin{equation}
\label{eqn:Gaussian}
I_{grad} = \exp(-|(\nabla \ast G) \cdot I|),
\end{equation}
where $I_{grad}$ is the gradient at some point, and $\nabla \ast G$ denotes the first order derivative of a Gaussian operator.

The edge images are mapped through an S-shaped function to get the edge potential maps (feature images):
\begin{equation}
\label{eqn:Sigmoid}
%I_{\sigma} = (I_{max} - I_{min}) \cdot \frac{1}{1 + \exp\left(-\frac{I_{grad} - n}{m}\right)} + I_{min},
I_{\sigma} = (I_{max} - I_{min}) \cdot \left(1 + \exp\left(-\frac{I_{grad} - n}{m}\right)\right)^{-1} + I_{min},
\end{equation}
where $I_{\sigma}$ denotes the output image, $I_{max}$ and $I_{min}$ represent the extreme values of the output intensities; $m$ controls the range of the input intensity, $n$ determines the location around which the range is centered. %
%The results may vary due to different choices of the parameters for the individual modules in the pipeline.
\begin{figure}[t]
\centering
\input{figuresrc/chap07/binary_threshold}
\caption{Binary thresholding function.}
\label{fig:BinaryThresholdFunc}
\end{figure}

\subsubsection{初始轮廓的生成}

The initial contours will be generated using the fast marching method \cite{Sethian1999}, a numerical method used for the tracking of the propagating interface.
The evolution begins from the appropriately selected seeding points.
For the planar curve $\mathcal{C} = \{(x,y) | T(x,y) = t\}$,
%\begin{equation}
%\label{eqn:Curves}
%\mathcal{C}(t) = \{(x,y) | T(x,y) = t\},
%\end{equation}
where $(x,y)$ represents some point in the image, and $T(x,y)$ marks the time when the interface crosses the point.
The algorithm realizes the tracking of the evolution by solving the following equation
\begin{equation}
\label{eqn:Eikonal}
1 = | \nabla T | F,
\end{equation}
where $F$ denotes the speed in the normal direction at some point $(x,y)$.
The interface propagates inwards when $F < 0$; and propagates outwards when $F > 0$.
If the speed function $F$ only depends the position of the point, then (\ref{eqn:Eikonal}) reduces to the Eikonal equation.
The resultant images are the time-crossing map in which the time-of-arrival at every point are computed.

\subsection{测地学活动轮廓的演进}

The geodesic ``snakes" method \cite{Caselles1997}, based on the classical ``snakes" model \cite{Kass1988}, is aimed to implement the detection of the boundaries of multiple objects simultaneously without additional routines. %
The idea of the classical model is to evolve a contour $\mathcal{C}$ such that the edge of the object can be detected, where the contour cannot deal with the change of its topology so that detecting more than one object in the image is impossible \cite{Caselles1997}. %.
Computationally, the adopted geodesic ``snakes" connects the geodesic calculation and the level set evolution.

The goal of this method is to find the following minimum:
\begin{equation}
\label{eqn:MinModel}
\min \int_0^1 g(|\nabla I_{\sigma} ( \mathcal{C} (q) )|) |\mathcal{C}' (q)| dq,
\end{equation}
% Thus the problem has been shifted from the minimization of (\ref{eqn:ParticularSnakes}) to the geodesic computation.
where $\mathcal{C}(q):[0,1]\rightarrow \mathrm{R}^2$ denotes the parametrized planar curve, $I_{\sigma}:[0,a]\times [0,b]\rightarrow \mathrm{R}^{+}$ represents the input image, $g(\cdot): [0, \infty) \rightarrow \mathrm{R}^{+}$ is a monotonically decreasing function. %
In (\ref{eqn:MinModel}), $g(\cdot)$ is equivalent to the speed of the evolution of the curve.
And it is also dependent upon the geometry of the image content.
For the ideal edges of the objects to be detected, the choice of parameter $g(\cdot)$ is independent of their geodesic computation.

To find the minimum of (\ref{eqn:MinModel}), the geodesic flow is calculated by
\begin{equation}
\label{eqn:EvolutionModel}
\mathcal{C}_t = \frac{\partial \mathcal{C}}{\partial t} = g(I_{\sigma}) \kappa \mathcal{N} - (\nabla g(I_{\sigma}) \cdot \mathcal{N}) \mathcal{N},
\end{equation}
where $\kappa$ is the Euclidean curvature of $\mathcal{C}$, $\mathcal{N}$ is the unit inward normal vector. %, and the right-hand side of the equation is the computation of Euler-Lagrange.
Equation (\ref{eqn:EvolutionModel}) shows the way $\mathcal{C}$ propagating towards the edges of the targets, i.e., the initial curve $\mathcal{C}(0)$ evolves to a (local) minimum of (\ref{eqn:MinModel}).

According to (\ref{eqn:EvolutionModel}), this evolution will stop at edges of the targets when $\mathcal{C}_t = 0$.
%According to (\ref{eqn:EvolutionModel}), this evolution will stop when $\frac{\partial \mathcal{C}(t)}{\partial t} = 0$, meaning that the boundaries of the objects are detected.
Imagine that $\mathcal{C}$ is a level-set of a function $u(\cdot):[0,a] \times [0,b] \rightarrow \mathrm{R}$, and considering (\ref{eqn:MinModel}), the former evolution (\ref{eqn:EvolutionModel}) is transformed to finding the steady state solution of the following equation: %
\begin{equation}
\label{eqn:LevelSetModel}
u_t = \frac{\partial u}{\partial t}  = g(I_{\sigma}) |\nabla u| \kappa + \nabla g(I_{\sigma}) \cdot \nabla u,
%\begin{split}
%\frac{\partial u}{\partial t} & = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) \\
%                              %& = g(I_{\sigma}) |\nabla u| \textrm{div} \left(\frac{\nabla u}{|\nabla u|}\right) + \nabla g(I_{\sigma}) \cdot \nabla u \\
%                              & = g(I_{\sigma}) |\nabla u| \kappa + \nabla g(I_{\sigma}) \cdot \nabla u,
%\end{split}
\end{equation}
where $\kappa = \textrm{div}\left( \nabla u \cdot |\nabla u|^{-1} \right)$.
%where $\kappa = \textrm{div}\left(\frac{\nabla u}{|\nabla u|}\right)$.

To increase the ``attraction" to the contour towards the edges, a term is added to (\ref{eqn:LevelSetModel}):
\begin{equation}
\label{eqn:GeodesicDriver}
%\label{eqn:Geodesic1}
u_t = g( I_{\sigma} )( c + \kappa ) |\nabla u| + \nabla u \cdot \nabla g(I_{\sigma}),
%u_t = |\nabla u| \textrm{div} \left(g(I_{\sigma}) \frac{\nabla u}{|\nabla u|}\right) + c g(I_{\sigma}) |\nabla u|,
\end{equation}
where $c$ is a constant and $c \in \mathrm{R}^+$.
Regarding (\ref{eqn:LevelSetModel}), %the above equation can be rewritten as
%\begin{equation}
%\label{eqn:Geodesic2}
%u_t = g( I_{\sigma} )( c + \kappa ) |\nabla u| + \nabla u \cdot \nabla g(I_{\sigma}).
%\end{equation}
% which means that the level sets move according to
equation (\ref{eqn:GeodesicDriver}) can be transformed to the following evolution equation
\begin{equation}
\label{eqn:GeodesicEvolution}
\mathcal{C}_t = g(I_{\sigma}) ( c + \kappa ) \mathcal{N} - ( \nabla g(I_{\sigma}) \cdot \mathcal{N} ) \mathcal{N}.
\end{equation}
The solution to this problem is equivalent to the zero level-set of the steady state (i.e., $u_t = 0$) of (\ref{eqn:GeodesicDriver}).

\subsection{等值面的提取}

To visualize the surface model, the surface information should be firstly extracted by the marching cubes method \cite{Lorensen1987MC}.
As the initial step of surface extraction, arrays of cubes are created from the input with each cube consisting of eight pixels (four from one slice and the other four from the next slice). %
Then the index for each cube is calculated by comparing the eight intensity values to the specified isovalue corresponding to the surfaces of the objects.
By referring to the triangulated cases with the indexes, the intersection patterns of the objects and the cubes can be roughly determined.
Then the precise edge intersections are computed using linear interpolation with the intensity values at each vertex of the cubes.
After that, the unit normals to the surface at each vertex of these cubes are computed via central differences.
The resulting triangles are then sent to the graphics systems and displayed by standard rendering techniques.
% The isovalue representing the edge of the segmented target is selected.
% Then the 3-D model of the target can be reconstructed.
% That is the 3-D surface model of the lumen of the aorta. 